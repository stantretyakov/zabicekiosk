# Pre-commit hooks for ODP platform
# See docs/development/precommit.md for setup and usage

repos:
  # ==================== Go Services ====================
  - repo: local
    hooks:
      - id: golangci-lint
        name: Go Linting (golangci-lint)
        entry: golangci-lint run
        language: system
        types: [go]
        pass_filenames: false
        args: ['--timeout=5m']

      - id: go-test
        name: Go Tests
        entry: go test
        language: system
        types: [go]
        pass_filenames: false
        args: ['./...', '-v', '-race', '-cover']

      - id: go-build
        name: Go Build
        entry: go build
        language: system
        types: [go]
        pass_filenames: false
        args: ['./...']

      - id: go-fmt
        name: Go Format (gofmt)
        entry: gofmt
        language: system
        types: [go]
        args: ['-w', '-s']

      - id: go-mod-tidy
        name: Go Mod Tidy
        entry: go mod tidy
        language: system
        types: [go]
        pass_filenames: false

  # ==================== Python Services ====================
  - repo: local
    hooks:
      - id: ruff-check
        name: Python Linting (ruff)
        entry: ruff check
        language: system
        types: [python]
        pass_filenames: false
        args: ['.', '--fix']

      - id: ruff-format
        name: Python Formatting (ruff)
        entry: ruff format
        language: system
        types: [python]
        pass_filenames: false

      - id: mypy
        name: Python Type Checking (mypy)
        entry: mypy
        language: system
        types: [python]
        pass_filenames: false
        args: ['.', '--strict']

      - id: pytest
        name: Python Tests (pytest)
        entry: pytest
        language: system
        types: [python]
        pass_filenames: false
        args: ['--cov', '--cov-report=term', '--cov-fail-under=80']

  # ==================== Frontend (React/TypeScript) ====================
  - repo: local
    hooks:
      - id: eslint
        name: ESLint (TypeScript/React)
        entry: bash -c 'cd apps/console-ui && npm run lint'
        language: system
        files: '\.(ts|tsx|js|jsx)$'
        pass_filenames: false

      - id: prettier
        name: Prettier (TypeScript/React)
        entry: bash -c 'cd apps/console-ui && npm run format'
        language: system
        files: '\.(ts|tsx|js|jsx|json|md|yml|yaml)$'
        pass_filenames: false

  # ==================== Docker & Compose ====================
  - repo: local
    hooks:
      - id: docker-compose-validate
        name: Docker Compose Validation
        entry: docker-compose
        language: system
        files: 'compose\.yml$'
        args: ['-f', 'ops/local/compose.yml', 'config', '--quiet']
        pass_filenames: false

  # ==================== YAML & JSON ====================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: check-yaml
        name: Check YAML Syntax
        args: ['--unsafe']  # Allow custom tags (for Docker Compose)

      - id: check-json
        name: Check JSON Syntax

      - id: check-toml
        name: Check TOML Syntax

  # ==================== Security ====================
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.4.0
    hooks:
      - id: detect-secrets
        name: Detect Secrets
        args: ['--baseline', '.secrets.baseline']
        exclude: |
          (?x)^(
              package-lock\.json|
              go\.sum|
              .*\.lock
          )$

  # ==================== General Hygiene ====================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        name: Trim Trailing Whitespace

      - id: end-of-file-fixer
        name: Fix End of Files

      - id: check-added-large-files
        name: Check Large Files
        args: ['--maxkb=500']

      - id: check-merge-conflict
        name: Check Merge Conflicts

      - id: check-case-conflict
        name: Check Case Conflicts

      - id: mixed-line-ending
        name: Check Line Endings
        args: ['--fix=lf']

  # ==================== Documentation ====================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: check-markdown
        name: Check Markdown Syntax
        files: '\.md$'

# Configuration
default_install_hook_types: [pre-commit]
default_stages: [commit]

# Performance optimization
fail_fast: false  # Run all hooks even if one fails (better feedback)

# Excludes
exclude: |
  (?x)^(
      \.backlog/|
      \.git/|
      \.venv/|
      venv/|
      node_modules/|
      vendor/|
      dist/|
      build/|
      .*\.pyc|
      .*\.pyo|
      .*\.swp|
      .*\.swo|
      .*\.bak
  )$
