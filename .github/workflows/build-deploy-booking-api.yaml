name: Build and Deploy Booking API

on:
  push:
    branches: [ main ]
    paths:
      - 'services/booking-api/**'
      - '.github/workflows/build-deploy-booking-api.yaml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality-gates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/booking-api/package-lock.json

      - name: Install Dependencies
        run: npm ci
        working-directory: services/booking-api

      - name: Lint
        run: npm run lint
        working-directory: services/booking-api

      - name: Type Check
        run: npm run typecheck
        working-directory: services/booking-api

      - name: Run Tests
        run: npm test -- --coverage --passWithNoTests
        working-directory: services/booking-api
        env:
          CI: true

      - name: Build
        run: npm run build
        working-directory: services/booking-api

  build-deploy:
    needs: quality-gates
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REGION: ${{ secrets.GCP_REGION }}
    steps:
      - uses: actions/checkout@v3
      - uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true
      - name: Build and Push
        run: |
          gcloud builds submit services/booking-api \
            --tag $REGION-docker.pkg.dev/$PROJECT_ID/services/booking-api:$GITHUB_SHA
      - name: Deploy
        run: |
          gcloud run deploy booking-api \
            --image $REGION-docker.pkg.dev/$PROJECT_ID/services/booking-api:$GITHUB_SHA \
            --region $REGION \
            --platform managed \
            --quiet
