name: Build and Deploy Core API

on:
  push:
    branches: [ main ]
    paths:
      - 'services/core-api/**'
      - '.github/workflows/build-deploy-core-api.yaml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REGION: ${{ secrets.GCP_REGION }}
    steps:
      - uses: actions/checkout@v3
      - uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true
      - name: Build and Push
        run: |
          gcloud builds submit services/core-api \
            --tag $REGION-docker.pkg.dev/$PROJECT_ID/services/core-api:$GITHUB_SHA
      - name: Deploy
        run: |
          gcloud run deploy core-api \
            --image $REGION-docker.pkg.dev/$PROJECT_ID/services/core-api:$GITHUB_SHA \
            --region $REGION \
            --platform managed \
            --quiet
